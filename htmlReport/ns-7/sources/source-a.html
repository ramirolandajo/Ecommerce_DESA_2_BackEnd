


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > PurchaseServiceImpl</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">ar.edu.uade.ecommerce.Service</a>
</div>

<h1>Coverage Summary for Class: PurchaseServiceImpl (ar.edu.uade.ecommerce.Service)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">PurchaseServiceImpl</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    94,1%
  </span>
  <span class="absValue">
    (16/17)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    71,4%
  </span>
  <span class="absValue">
    (40/56)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    75%
  </span>
  <span class="absValue">
    (99/132)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package ar.edu.uade.ecommerce.Service;
&nbsp;
&nbsp;import ar.edu.uade.ecommerce.Entity.*;
&nbsp;import ar.edu.uade.ecommerce.Entity.Purchase.Status;
&nbsp;import ar.edu.uade.ecommerce.Repository.PurchaseRepository;
&nbsp;import ar.edu.uade.ecommerce.KafkaCommunication.KafkaMockService;
&nbsp;import com.fasterxml.jackson.databind.ObjectMapper;
&nbsp;import org.springframework.beans.factory.annotation.Autowired;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import org.springframework.scheduling.annotation.Scheduled;
&nbsp;
&nbsp;import java.time.LocalDateTime;
&nbsp;import java.util.List;
&nbsp;import java.util.Optional;
&nbsp;import ar.edu.uade.ecommerce.Entity.DTO.PurchaseInvoiceDTO;
&nbsp;import ar.edu.uade.ecommerce.Entity.DTO.PurchaseInvoiceDTO.ProductDetailDTO;
&nbsp;import ar.edu.uade.ecommerce.Repository.UserRepository;
&nbsp;import ar.edu.uade.ecommerce.Repository.ProductRepository;
&nbsp;import org.slf4j.Logger;
&nbsp;import org.slf4j.LoggerFactory;
&nbsp;
&nbsp;@Service
<b class="fc">&nbsp;public class PurchaseServiceImpl implements PurchaseService {</b>
&nbsp;    @Autowired
&nbsp;    private PurchaseRepository purchaseRepository;
&nbsp;    @Autowired
&nbsp;    private KafkaMockService kafkaMockService;
&nbsp;    @Autowired
&nbsp;    private ObjectMapper objectMapper;
&nbsp;    @Autowired
&nbsp;    private UserRepository userRepository;
&nbsp;    @Autowired
&nbsp;    private ProductRepository productRepository;
&nbsp;    @Autowired
&nbsp;    private AuthService authService;
&nbsp;
&nbsp;    @Autowired
&nbsp;    private ProductService productService;
&nbsp;
<b class="fc">&nbsp;    private static final Logger logger = LoggerFactory.getLogger(PurchaseServiceImpl.class);</b>
&nbsp;
&nbsp;    @Override
&nbsp;    public Purchase save(Purchase purchase) {
&nbsp;        // Si la compra pasa a PENDING, setear reservationTime
<b class="fc">&nbsp;        if (purchase.getStatus() == Status.PENDING &amp;&amp; purchase.getReservationTime() == null) {</b>
<b class="fc">&nbsp;            purchase.setReservationTime(LocalDateTime.now());</b>
&nbsp;            // Avisar por Kafka que se debe reservar el stock
&nbsp;            try {
<b class="fc">&nbsp;                String json = objectMapper.writeValueAsString(purchase);</b>
<b class="fc">&nbsp;                Event event = new Event(&quot;ReserveStock&quot;, json);</b>
<b class="fc">&nbsp;                kafkaMockService.sendEvent(event);</b>
<b class="fc">&nbsp;                kafkaMockService.mockListener(event); // Mock de recepción</b>
&nbsp;            } catch (Exception e) {
<b class="fc">&nbsp;                logger.error(&quot;Error en reserva de stock&quot;, e);</b>
&nbsp;            }
&nbsp;        }
<b class="fc">&nbsp;        return purchaseRepository.save(purchase);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Purchase findById(Integer id) {
<b class="fc">&nbsp;        Optional&lt;Purchase&gt; purchase = purchaseRepository.findById(id);</b>
<b class="fc">&nbsp;        return purchase.orElse(null);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public List&lt;Purchase&gt; findAll() {
<b class="fc">&nbsp;        return purchaseRepository.findAll();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void deleteById(Integer id) {
<b class="fc">&nbsp;        Purchase purchase = findById(id);</b>
<b class="fc">&nbsp;        if (purchase != null &amp;&amp; purchase.getStatus() != Status.CANCELLED) {</b>
<b class="fc">&nbsp;            purchase.setStatus(Status.CANCELLED);</b>
<b class="fc">&nbsp;            purchaseRepository.save(purchase);</b>
&nbsp;            // Avisar por Kafka que se debe liberar el stock
&nbsp;            try {
<b class="fc">&nbsp;                String json = objectMapper.writeValueAsString(purchase);</b>
<b class="fc">&nbsp;                Event event = new Event(&quot;ReleaseStock&quot;, json);</b>
<b class="fc">&nbsp;                kafkaMockService.sendEvent(event);</b>
<b class="fc">&nbsp;                kafkaMockService.mockListener(event);</b>
&nbsp;            } catch (Exception e) {
<b class="fc">&nbsp;                logger.error(&quot;Error al liberar reserva por cancelación manual&quot;, e);</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Purchase confirmPurchase(Integer id) {
<b class="fc">&nbsp;        Purchase purchase = findById(id);</b>
<b class="fc">&nbsp;        if (purchase == null) {</b>
<b class="fc">&nbsp;            logger.warn(&quot;Intento de confirmar compra inexistente. ID: {}&quot;, id);</b>
<b class="fc">&nbsp;            return null;</b>
&nbsp;        }
<b class="fc">&nbsp;        logger.info(&quot;Confirmando compra. Estado previo: {}&quot;, purchase.getStatus());</b>
<b class="fc">&nbsp;        purchase.setStatus(Status.CONFIRMED);</b>
<b class="fc">&nbsp;        purchase.setDate(LocalDateTime.now()); // Setea la fecha de confirmación</b>
<b class="fc">&nbsp;        purchaseRepository.save(purchase);</b>
&nbsp;        try {
<b class="fc">&nbsp;            String json = objectMapper.writeValueAsString(purchase);</b>
<b class="fc">&nbsp;            Event event = new Event(&quot;PurchaseConfirmed_GenerateInvoice&quot;, json);</b>
<b class="fc">&nbsp;            kafkaMockService.sendEvent(event);</b>
<b class="fc">&nbsp;            kafkaMockService.mockListener(event);</b>
&nbsp;        } catch (Exception e) {
<b class="fc">&nbsp;            logger.error(&quot;Error al confirmar compra y generar factura&quot;, e);</b>
&nbsp;        }
<b class="fc">&nbsp;        logger.info(&quot;Compra confirmada. Estado actual: {}&quot;, purchase.getStatus());</b>
<b class="fc">&nbsp;        return purchase;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void addProductToCart(Integer cartId, Integer productId, int quantity) {
&nbsp;        // Lógica para agregar producto al carrito
&nbsp;        // ...
<b class="fc">&nbsp;        Event event = new Event(&quot;ProductAddedToCart&quot;, &quot;CartId: &quot; + cartId + &quot;, ProductId: &quot; + productId + &quot;, Quantity: &quot; + quantity);</b>
<b class="fc">&nbsp;        kafkaMockService.sendEvent(event);</b>
<b class="fc">&nbsp;        kafkaMockService.mockListener(event);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void editCartItem(Integer cartItemId, int newQuantity) {
&nbsp;        // Lógica para editar cantidad de producto en el carrito
&nbsp;        // ...
<b class="fc">&nbsp;        Event event = new Event(&quot;CartItemEdited&quot;, &quot;CartItemId: &quot; + cartItemId + &quot;, NewQuantity: &quot; + newQuantity);</b>
<b class="fc">&nbsp;        kafkaMockService.sendEvent(event);</b>
<b class="fc">&nbsp;        kafkaMockService.mockListener(event);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void removeProductFromCart(Integer cartItemId) {
&nbsp;        // Lógica para eliminar producto del carrito
&nbsp;        // ...
<b class="fc">&nbsp;        Event event = new Event(&quot;ProductRemovedFromCart&quot;, &quot;CartItemId: &quot; + cartItemId);</b>
<b class="fc">&nbsp;        kafkaMockService.sendEvent(event);</b>
<b class="fc">&nbsp;        kafkaMockService.mockListener(event);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Scheduled(fixedRate = 60000) // Cada 1 minuto
&nbsp;    public void releaseExpiredReservations() {
<b class="fc">&nbsp;        List&lt;Purchase&gt; pendingPurchases = purchaseRepository.findAll().stream()</b>
<b class="pc">&nbsp;                .filter(p -&gt; p.getStatus() == Status.PENDING &amp;&amp; p.getReservationTime() != null)</b>
<b class="fc">&nbsp;                .toList();</b>
<b class="fc">&nbsp;        for (Purchase purchase : pendingPurchases) {</b>
<b class="fc">&nbsp;            if (purchase.getReservationTime().plusHours(4).isBefore(LocalDateTime.now())) {</b>
&nbsp;                // Avisar por Kafka que se debe liberar el stock
&nbsp;                try {
<b class="fc">&nbsp;                    String json = objectMapper.writeValueAsString(purchase);</b>
<b class="fc">&nbsp;                    Event event = new Event(&quot;ReleaseStock&quot;, json);</b>
<b class="fc">&nbsp;                    kafkaMockService.sendEvent(event);</b>
<b class="fc">&nbsp;                    kafkaMockService.mockListener(event); // Mock de recepción</b>
&nbsp;                } catch (Exception e) {
<b class="fc">&nbsp;                    logger.error(&quot;Error al liberar reserva&quot;, e);</b>
&nbsp;                }
<b class="fc">&nbsp;                purchase.setStatus(Status.CANCELLED);</b>
<b class="fc">&nbsp;                purchaseRepository.save(purchase);</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public String mockStockChange(Integer productId, int newStock) {
<b class="fc">&nbsp;        Product updatedProduct = productService.updateProductStock(productId, newStock);</b>
<b class="fc">&nbsp;        return &quot;Cambio detectado de stock. Producto actualizado: &quot; + updatedProduct;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public String getEmailFromToken(String token) {
<b class="fc">&nbsp;        return authService.getEmailFromToken(token);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public List&lt;PurchaseInvoiceDTO&gt; getPurchasesByUserEmail(String email) {
<b class="fc">&nbsp;        User user = userRepository.findByEmail(email);</b>
<b class="fc">&nbsp;        if (user == null) return List.of();</b>
<b class="fc">&nbsp;        List&lt;Purchase&gt; purchases = purchaseRepository.findByUser_Id(user.getId());</b>
<b class="fc">&nbsp;        List&lt;PurchaseInvoiceDTO&gt; invoices = new java.util.ArrayList&lt;&gt;();</b>
<b class="pc">&nbsp;        if (purchases == null) return invoices;</b>
<b class="fc">&nbsp;        for (Purchase purchase : purchases) {</b>
<b class="fc">&nbsp;            if (purchase.getStatus() != Purchase.Status.CONFIRMED) continue;</b>
<b class="fc">&nbsp;            PurchaseInvoiceDTO invoice = new PurchaseInvoiceDTO();</b>
<b class="fc">&nbsp;            invoice.setPurchaseId(purchase.getId());</b>
<b class="fc">&nbsp;            invoice.setPurchaseDate(purchase.getDate());</b>
<b class="fc">&nbsp;            if (purchase.getCart() == null) {</b>
<b class="fc">&nbsp;                invoice.setTotalAmount(0.0F);</b>
<b class="fc">&nbsp;                invoice.setProducts(new java.util.ArrayList&lt;&gt;());</b>
<b class="fc">&nbsp;                invoices.add(invoice);</b>
&nbsp;                continue;
&nbsp;            }
<b class="fc">&nbsp;            invoice.setTotalAmount(purchase.getCart().getFinalPrice());</b>
<b class="fc">&nbsp;            List&lt;ProductDetailDTO&gt; products = new java.util.ArrayList&lt;&gt;();</b>
<b class="fc">&nbsp;            List&lt;CartItem&gt; items = purchase.getCart().getItems();</b>
<b class="fc">&nbsp;            if (items != null) {</b>
<b class="fc">&nbsp;                for (CartItem item : items) {</b>
<b class="fc">&nbsp;                    Product product = productRepository.findById(item.getId()).orElse(null);</b>
<b class="fc">&nbsp;                    if (product == null) continue;</b>
<b class="fc">&nbsp;                    ProductDetailDTO pd = new ProductDetailDTO();</b>
<b class="fc">&nbsp;                    pd.setId(product.getId());</b>
<b class="fc">&nbsp;                    pd.setDescription(product.getDescription());</b>
<b class="fc">&nbsp;                    pd.setStock(product.getStock());</b>
<b class="fc">&nbsp;                    pd.setPrice(product.getPrice());</b>
<b class="fc">&nbsp;                    products.add(pd);</b>
&nbsp;                }
&nbsp;            }
<b class="fc">&nbsp;            invoice.setProducts(products);</b>
<b class="fc">&nbsp;            invoices.add(invoice);</b>
&nbsp;        }
<b class="fc">&nbsp;        return invoices;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Purchase findLastPendingPurchaseByUserWithinHours(Integer userId, int hours) {
<b class="fc">&nbsp;        List&lt;Purchase&gt; purchases = purchaseRepository.findByUser_IdAndStatusOrderByReservationTimeDesc(userId, Purchase.Status.PENDING);</b>
<b class="fc">&nbsp;        if (purchases == null) return null;</b>
<b class="fc">&nbsp;        java.time.LocalDateTime now = java.time.LocalDateTime.now();</b>
<b class="fc">&nbsp;        for (Purchase purchase : purchases) {</b>
<b class="fc">&nbsp;            if (purchase.getReservationTime() != null &amp;&amp; purchase.getReservationTime().plusHours(hours).isAfter(now)) {</b>
<b class="fc">&nbsp;                return purchase;</b>
&nbsp;            }
&nbsp;        }
<b class="fc">&nbsp;        return null;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public List&lt;Purchase&gt; findByUserId(Integer id) {
<b class="fc">&nbsp;        return purchaseRepository.findByUser_Id(id);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public List&lt;ar.edu.uade.ecommerce.Entity.DTO.PurchaseWithCartDTO&gt; getPurchasesWithCartByUserId(Integer userId) {
<b class="nc">&nbsp;        List&lt;Purchase&gt; purchases = purchaseRepository.findByUser_Id(userId);</b>
<b class="nc">&nbsp;        List&lt;ar.edu.uade.ecommerce.Entity.DTO.PurchaseWithCartDTO&gt; dtos = new java.util.ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        for (Purchase purchase : purchases) {</b>
<b class="nc">&nbsp;            if (purchase.getStatus() != Purchase.Status.CONFIRMED) continue;</b>
<b class="nc">&nbsp;            ar.edu.uade.ecommerce.Entity.DTO.PurchaseWithCartDTO dto = new ar.edu.uade.ecommerce.Entity.DTO.PurchaseWithCartDTO();</b>
<b class="nc">&nbsp;            dto.setId(purchase.getId());</b>
<b class="nc">&nbsp;            dto.setDate(purchase.getDate());</b>
<b class="nc">&nbsp;            dto.setReservationTime(purchase.getReservationTime());</b>
<b class="nc">&nbsp;            dto.setDirection(purchase.getDirection());</b>
<b class="nc">&nbsp;            dto.setStatus(purchase.getStatus() != null ? purchase.getStatus().name() : null);</b>
<b class="nc">&nbsp;            if (purchase.getCart() != null) {</b>
<b class="nc">&nbsp;                ar.edu.uade.ecommerce.Entity.DTO.PurchaseWithCartDTO.CartDTO cartDto = new ar.edu.uade.ecommerce.Entity.DTO.PurchaseWithCartDTO.CartDTO();</b>
<b class="nc">&nbsp;                cartDto.setId(purchase.getCart().getId());</b>
<b class="nc">&nbsp;                cartDto.setFinalPrice(purchase.getCart().getFinalPrice());</b>
<b class="nc">&nbsp;                java.util.List&lt;ar.edu.uade.ecommerce.Entity.DTO.PurchaseWithCartDTO.CartItemDTO&gt; itemDtos = new java.util.ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;                if (purchase.getCart().getItems() != null) {</b>
<b class="nc">&nbsp;                    for (ar.edu.uade.ecommerce.Entity.CartItem item : purchase.getCart().getItems()) {</b>
<b class="nc">&nbsp;                        ar.edu.uade.ecommerce.Entity.DTO.PurchaseWithCartDTO.CartItemDTO itemDto = new ar.edu.uade.ecommerce.Entity.DTO.PurchaseWithCartDTO.CartItemDTO();</b>
<b class="nc">&nbsp;                        itemDto.setId(item.getId());</b>
<b class="nc">&nbsp;                        itemDto.setQuantity(item.getQuantity());</b>
<b class="nc">&nbsp;                        if (item.getProduct() != null) {</b>
<b class="nc">&nbsp;                            ar.edu.uade.ecommerce.Entity.DTO.PurchaseWithCartDTO.ProductDTO productDto = new ar.edu.uade.ecommerce.Entity.DTO.PurchaseWithCartDTO.ProductDTO();</b>
<b class="nc">&nbsp;                            productDto.setId(item.getProduct().getId());</b>
<b class="nc">&nbsp;                            productDto.setTitle(item.getProduct().getTitle());</b>
<b class="nc">&nbsp;                            productDto.setDescription(item.getProduct().getDescription());</b>
<b class="nc">&nbsp;                            productDto.setPrice(item.getProduct().getPrice());</b>
<b class="nc">&nbsp;                            productDto.setStock(item.getProduct().getStock());</b>
<b class="nc">&nbsp;                            itemDto.setProduct(productDto);</b>
&nbsp;                        }
<b class="nc">&nbsp;                        itemDtos.add(itemDto);</b>
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;                cartDto.setItems(itemDtos);</b>
<b class="nc">&nbsp;                dto.setCart(cartDto);</b>
&nbsp;            }
<b class="nc">&nbsp;            dtos.add(dto);</b>
&nbsp;        }
<b class="nc">&nbsp;        return dtos;</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-09-14 17:59</div>
</div>
</body>
</html>
